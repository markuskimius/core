#!/usr/bin/env bash

##############################################################################
# CORE: Essential unix utilities
# https://github.com/markuskimius/core
#
# Copyright (c)2020-2024 Mark Kim
# Released under GNU General Public License version 2.
# https://github.com/markuskimius/core/blob/main/LICENSE
##############################################################################

function usage() {
    cat <<EOF
Control the crontab.

Usage: ${SCRIPTNAME} COMMAND

COMMAND:
  install               Install the crontab from the configs.
  show                  Print the crontab to install.
  diff                  Diff the crontab to install.

The crontab is generated from the configuration by combining all files matching
the pattern "${DPM}/*/etc/core-cron.tab" and processing them via core-doc.sh.

EOF
}


##############################################################################
# PROGRAM BEGINS HERE

source "getopt.sh" || exit 1
source "core-doc.sh" || exit 1

SCRIPTNAME=$(basename -- "$BASH_SOURCE")
CORK=${CORK-${HOME}/work}
BASHRC=${CORK}/.bashrc


function main() {
    local OPTOPT OPTARG
    local cmd

    # Process options
    while getopt-sh "h" "help" "$@"; do
        case "$OPTOPT" in
            -h|--help)  usage && exit 0 ;;
            *)          exitcode=1      ;;
        esac
    done
    cmd=${OPTARG[0]}

    # Sanity check
    if (( ! ${#OPTARG[@]} )); then
        printf "COMMAND required\n\n" 1>&2
        exitcode=1
    fi

    if (( exitcode )); then
        usage 1>&2
        exit $exitcode
    fi

    # Execute command
    case "$cmd" in
        install) cron-install "${OPTARG[@]:1}" ;;
        show)    cron-show    "${OPTARG[@]:1}" ;;
        diff)    cron-diff    "${OPTARG[@]:1}" ;;
        *)       printf "%s: Invalid command\n" "${cmd}" && exit 1;;
    esac
}


function cron-install() {
    local newtab=$(cron-show)

    # Show the diff without the comments injected by cron (3 lines)
    "${DIFF-diff}" -u <(crontab -l | tail -n +4) <(printf "%s\n\n" "$newtab")

    # Create bashrc used by the cronjob
    printf "Generating ${BASHRC} ...\n"
    mkdir -p "${CORK}"
    cat-sh > "${BASHRC}" <<EOF
##############################################################################
# Auto generated by '${SCRIPTNAME}' on $(date)

# eval 'dpm setup' only once
if [[ -z "\$__CORE__" ]]; then
    export __CORE__=1
    eval "\$($(printf "%q" "$(which bash)") --norc --noprofile $(printf "%q" "$(which dpm)") setup)"
fi
EOF

    # Install the new crontab
    printf "Applying new crontab...\n"
    printf "%s\n\n" "$newtab" | crontab -
}


function cron-show() {
    # Output the crontab
    cat-sh <<EOF
##############################################################################
# Auto generated by '${SCRIPTNAME}' on $(date)

BASH_ENV="${BASHRC}"
EOF

    printf "\n"

    core-doc "core-cron.tab"
}


function cron-diff() {  
    # Show the diff without the comments injected by cron (3 lines)
    "${DIFF-diff}" -u "$@" <(crontab -l | tail -n +4) <(cron-show)
}


function cat-sh() {
    local file=$1

    if [[ -z "$file" ]]; then
        file=/dev/stdin
    fi

    printf "%s\n" "$(< "$file")"
}


##############################################################################
# ENTRY POINT

main "$@"


# vim:ft=bash
